<div class="screator-app flex flex-column h-full surface-ground">
  <p-toolbar class="screator-toolbar surface-card shadow-2">
    <div class="w-full flex align-items-center flex-wrap gap-3">
      <span class="app-title text-2xl font-semibold">Screator</span>
      <span class="flex-grow-1"></span>
      <div class="flex flex-column gap-1 dropdown-group">
        <span class="dropdown-label text-sm text-600">Slide chooser</span>
        <p-select class="slide-dropdown w-16rem" [options]="allSlides" optionLabel="slide_name"
          [showClear]="true" [(ngModel)]="selectedSlide" placeholder="Choose a slide">
          <ng-template pTemplate="selectedItem" let-slide>
            @if (slide) {
              <div class="flex align-items-center gap-2">
                <img [src]="slide.slide_file" class="slide-select-option border-round" />
                <span class="text-sm font-medium">{{ slide.slide_name }}</span>
              </div>
            } @else {
              <span class="text-sm text-500">Choose a slide</span>
            }
          </ng-template>
          <ng-template pTemplate="item" let-slide>
            <div class="flex align-items-center gap-2">
              <img [src]="slide.slide_file" class="slide-select-option border-round" />
              <div class="flex flex-column">
                <span class="font-medium">{{ slide.slide_name }}</span>
              </div>
            </div>
          </ng-template>
        </p-select>
      </div>
      <div class="flex flex-column gap-1 dropdown-group">
        <span class="dropdown-label text-sm text-600">Selected script</span>
        <p-select class="script-dropdown w-12rem" [options]="scripts" optionLabel="label" optionValue="value"
          [(ngModel)]="selectedScript" placeholder="Choose script" (onChange)="onScriptSelected()"></p-select>
      </div>
      <div class="flex align-items-center gap-2 action-group">
        <button pButton type="button" icon="pi pi-undo" class="p-button-rounded p-button-text"
          [disabled]="!(undoHistoryExists$ | async)" (click)="undo()"></button>
        <button pButton type="button" icon="pi pi-redo" class="p-button-rounded p-button-text"
          [disabled]="!(redoHistoryExists$ | async)" (click)="redo()"></button>
        <button pButton type="button" icon="pi pi-refresh" class="p-button-rounded p-button-text"
          [disabled]="!(scriptEdited$ | async)" (click)="onScriptSelected()"></button>
        <button pButton type="button" label="Save Script" icon="pi pi-save"
          class="p-button-raised p-button-primary tb-button" [disabled]="!(scriptEdited$ | async)"
          (click)="saveScript()"></button>
      </div>
    </div>
  </p-toolbar>
  <div class="content-wrapper flex-1 overflow-auto">
    @if (paragraphs$ | async; as paragraphs) {
      <div class="paragraph-container flex flex-column gap-4">
        @for (paragraph of paragraphs; track paragraph) {
          <div class="script-paragraph relative">
            <div class="paragraph-actions flex gap-2">
              <button pButton type="button" icon="pi pi-download" class="p-button-rounded p-button-outlined"
                [disabled]="!selectedSlide" (click)="insertSelectedSlide(paragraph)"></button>
            </div>
            <div class="paragraph-layout flex align-items-start">
              <div class="paragraph-content flex flex-column gap-4">
                <div class="slides-column">
                  @if (paragraph.slideCandidates?.length) {
                    <p-carousel class="slide-carousel" [value]="paragraph.slideCandidates" [numVisible]="1" [numScroll]="1"
                      [showIndicators]="false" [showNavigators]="paragraph.slideCandidates.length > 1"
                      [circular]="paragraph.slideCandidates.length > 1">
                      <ng-template pTemplate="item" let-slideCandidate>
                        <div class="slide-wrapper border-1 surface-border border-round-md overflow-hidden"
                          [ngClass]="{ 'selected-slide': slideCandidate.selected, 'with-action-bar': !slideCandidate.selected }">
                          <img [src]="slideCandidate.slide_file" class="slide" />
                          <div class="overlay">
                            <div class="score-bar" [style.width.%]="slideCandidate.score * 100"></div>
                          </div>
                          @if (!slideCandidate.selected) {
                            <div class="slide-action-bar">
                              <button pButton type="button" icon="pi pi-check" label="Approve"
                                class="slide-action-button approve-button"
                                (click)="selectSlideCandidate(paragraph, slideCandidate)"></button>
                              <button pButton type="button" icon="pi pi-times" label="Reject"
                                class="slide-action-button reject-button"
                                (click)="rejectSlideCandidate(paragraph, slideCandidate)"></button>
                            </div>
                          }
                        </div>
                      </ng-template>
                    </p-carousel>
                  } @else {
                    <div class="no-slides surface-border border-1 border-round-md text-sm text-500 p-3 text-center">
                      No slide matches found
                    </div>
                  }
                </div>
                <div class="paragraph-text border-round surface-section shadow-1">
                  @if (hasSelectedSlide(paragraph)) {
                    <i class="pi pi-check-circle paragraph-status-icon"></i>
                  }
                  <div class="paragraph-text-body">
                    {{ paragraph.text }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>